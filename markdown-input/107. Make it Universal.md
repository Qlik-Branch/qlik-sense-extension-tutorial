# 107. Make it Universal
Learning goal: Identify key considerations when building extensions that need to be deployed across environments

<div class="graph"></div>

We’ve built a simple table that can take in dynamic Qlik data, respond to user entered properties, and format itself based on size. However, we’ve only tested our extension on Qlik Sense Desktop. Will our extension work the same when we upload it to a server? Will it work for any server we upload it to? What about printing? Let’s discuss some considerations when building extensions that need to work across environments.

<div class="graph"></div>

## Environment Context
The Extension APIs are consistent across environments, so there is no need to worry about calls working on Desktop vs. Server. However, there is a third environment where your extension might run: via the print service. 

### The Print Service
When exporting an image of an extension, Qlik runs your extension code via the print service. The print service used a cached set of data and is not connected to the QIX Engine in real time. This limits some of the functions that can be performed, such as using the [Capabilities API](http://help.qlik.com/en-US/sense-developer/3.2/Subsystems/APIs/Content/mashup-api-reference.htm) to interact with the QIX Engine. Using the Capabilities API within an extension is not covered in this course, but if you are using it, you could run into issues if you attempt to call it in the print service.

<div id="print-service-editor" class="graph"></div>

In order to isolate code that shouldn’t run in the print service, you can add a check for the print service via the [Backend API](http://help.qlik.com/en-US/sense-developer/3.2/Subsystems/APIs/Content/backend-api-reference.htm). If the Backend API has a property called “isSnapshot” that is true, then the current context of the extension is the print service. You can create a variable to capture this like: 

### Absolute vs. Relative Paths
Sometimes in extensions, we may use external files. For example, if creating a chart with icons, we will need to reference image files for the icons. In those situations, it is crucial that we don’t rely on absolute paths. Why? Imagine you are creating an extension and testing it out on a test server called `testserver`. You could load the image like so: `http://testserver/extensions/myExtension/images` . However, if you try to move this extension to a production server, it will no longer work as the address above references the test server instead of the production server. Be sure when using paths to load files that they are either relative paths or dynamically generated based on their location. Another alternative is to host additional resources on a third-party server that can be accessed by any of your target environments.

<div id="support-editor" class="graph"></div>

## Printing Extensions
As mentioned above, the print service enables us to export images of our extension. Let’s enable this feature by opening _support.js_ and adding the `export` property:
_support.js_

<div id="export-pdf" class="graph">![](./imgs/export-pdf.png)</div>

Now we can export our extension to an image or PDF with a right-click.

### Limitations
Note that there are 2 key support limitations of printing extensions, [per the documentation](http://help.qlik.com/en-US/sense-developer/3.2/Subsystems/APIs/Content/ExtensionAPI/export-property.htm):
* Qlik Sense does not support exporting or printing of visualization extensions that use external resources.
* Qlik Sense does not support exporting or printing of visualization extensions that uses internal and undocumented JavaScript modules or APIs.

While these functions are not supported by Qlik Sense, they are technically feasible but must be managed by the developer, with no reliance on the Extension API for them. For example, you can load an external resource if the print service is able to access it, which usually requires using a third-party hosting solution with unrestricted access.

<div id="paint-editor" class="graph"></div>

### What about async?
When printing our extension, the print services waits for a certain period of time for the extension to finish rendering, then takes a snapshot of it. However, what if we have an extension that takes longer to complete? What if our extension relies on some asynchronous events that need to finish before rendering can happen? 

The answer to these problems is to provide a signal back to Qlik Sense about when our extension is ready for printing. This can be done via the `paint` function. Let’s first consider what we have done with the `paint` function in our extension. It basically follows the format:

<div id="paint-editor-2" class="graph"></div>

Our `paint` function manipulates the web page to draw our chart, but it never returns anything to it’s caller. However, Qlik Sense allows you to return a `Promise` from the `paint` function if you want to signal when the extension is ready for printing. [A Promise is an object in JavaScript that allows you to return a value asynchronously.](https://developers.google.com/web/fundamentals/getting-started/primers/promises) If Qlik Sense gets a Promise back from your `paint` function, it assumes that when this `Promise` is fulfilled, the extension is done rendering and it should print. This functionality will give you a higher degree of control over this process, if you need it for complicated situations like asynchronous processes in your extension. An example of a barebones paint function with this method in place may look like so:

In this example, we used `fetch` to do an asynchronous call to an external resource. We created a Promise around that code so that the print service will know when the request is done and the chart can be printed.

<div class="graph"></div>

## Fin
#### Recap
* Extensions can be deployed across multiple environments, so be careful of writing any code that is environment specific
* The print service has some limitations
* An extension’s paint function can return a Promise that will signal when an extension is done rendering and is ready for printing

#### Resources
* [Extension Export Documentation](http://help.qlik.com/en-US/sense-developer/3.2/Subsystems/APIs/Content/ExtensionAPI/export-property.htm)
* [Promises in JS](https://developers.google.com/web/fundamentals/getting-started/primers/promises)

#### Troubleshooting Guide
* 
